"use strict";define(["exports"],function(e){function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t,n){return{kind:e,value:t,precedence:n||0}}function r(e,t){return new O(e,t).parse()}Object.defineProperty(e,"__esModule",{value:!0}),e.token=n,e.parse=r;var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a="()[]{}",s="+-*/!&%<=>?^|",u=["==","!=","<=",">=","||","&&"],h=["===","!=="],o=["this"],c=["+","-","!"],_=["+","-","*","/","%","^","==","!=",">","<",">=","<=","||","&&","&","===","!==","|"],v={"!":0,":":0,",":0,")":0,"]":0,"}":0,"?":1,"||":2,"&&":3,"|":4,"^":5,"&":6,"!=":7,"==":7,"!==":7,"===":7,">=":8,">":8,"<=":8,"<":8,"+":9,"-":9,"%":10,"/":10,"*":10,"(":11,"[":11,".":11,"{":11},l=11,f=1,d=2,p=3,k=4,y=5,x=6,g=7,m=8,I=9,E=10,w=(e.PRECEDENCE=v,e.POSTFIX_PRECEDENCE=l,e.STRING=f,e.IDENTIFIER=d,e.DOT=p,e.COMMA=k,e.COLON=y,e.INTEGER=x,e.DECIMAL=g,e.OPERATOR=m,e.GROUPER=I,e.KEYWORD=E,e.Tokenizer=function(){function e(e){return/^\s$/.test(e)}function r(e){return/^[a-zA-Z_$]$/.test(e)}function c(e){return/^[a-zA-Z0-9_$]$/.test(e)}function _(e){return-1!==o.indexOf(e)}function w(e){return/^[\"\']$/.test(e)}function O(e){return/^[0-9]$/.test(e)}function z(e){return-1!==s.indexOf(e)}function b(e){return-1!==a.indexOf(e)}function P(e){return e.replace(/\\(.)/g,function(e,t){switch(t){case"n":return"\n";case"r":return"\r";case"t":return"	";case"b":return"\b";case"f":return"\f";default:return t}})}var D=function(){function a(e){t(this,a),this._input=e,this._index=-1,this._tokenStart=0,this._next=null}return i(a,[{key:"_advance",value:function(e){this._index<this._input.length?(this._index++,this._next=this._input[this._index],e&&(this._tokenStart=this._index)):this._next=null}},{key:"_getValue",value:function(e){var t=this._input.substring(this._tokenStart,this._index+(e||0));return e||this._clearValue(),t}},{key:"_clearValue",value:function(){this._tokenStart=this._index}},{key:"nextToken",value:function(){for(-1===this._index&&this._advance();e(this._next);)this._advance(!0);return w(this._next)?this._tokenizeString():r(this._next)?this._tokenizeIdentOrKeyword():O(this._next)?this._tokenizeNumber():"."===this._next?this._tokenizeDot():","===this._next?this._tokenizeComma():":"===this._next?this._tokenizeColon():z(this._next)?this._tokenizeOperator():b(this._next)?this._tokenizeGrouper():(this._advance(),console.assert(!this._next),null)}},{key:"_tokenizeString",value:function(){var e="unterminated string",t=this._next;for(this._advance(!0);this._next!==t;){if(!this._next)throw new Error(e);if("\\"===this._next&&(this._advance(),!this._next))throw new Error(e);this._advance()}var r=n(f,P(this._getValue()));return this._advance(),r}},{key:"_tokenizeIdentOrKeyword",value:function(){for(;c(this._next);)this._advance();var e=this._getValue(),t=_(e)?E:d;return n(t,e)}},{key:"_tokenizeNumber",value:function(){for(;O(this._next);)this._advance();return"."===this._next?this._tokenizeDot():n(x,this._getValue())}},{key:"_tokenizeDot",value:function(){return this._advance(),O(this._next)?this._tokenizeFraction():(this._clearValue(),n(p,".",l))}},{key:"_tokenizeComma",value:function(){return this._advance(!0),n(k,",")}},{key:"_tokenizeColon",value:function(){return this._advance(!0),n(y,":")}},{key:"_tokenizeFraction",value:function(){for(;O(this._next);)this._advance();return n(g,this._getValue())}},{key:"_tokenizeOperator",value:function(){this._advance();var e=this._getValue(2);return-1!==h.indexOf(e)?(this._advance(),this._advance()):(e=this._getValue(1),-1!==u.indexOf(e)&&this._advance()),e=this._getValue(),n(m,e,v[e])}},{key:"_tokenizeGrouper",value:function(){var e=this._next,t=n(I,e,v[e]);return this._advance(!0),t}}]),a}();return D}()),O=e.Parser=function(){function e(n,r){t(this,e),this._tokenizer=new w(n),this._ast=r,this._token=null,this._kind=null,this._value=null}return i(e,[{key:"parse",value:function(){return this._advance(),this._parseExpression()}},{key:"_advance",value:function(e,t){if(!this._matches(e,t))throw new Error("Expected kind "+e+" ("+t+"), was "+this._token);var n=this._tokenizer.nextToken();this._token=n,this._kind=n&&n.kind,this._value=n&&n.value}},{key:"_matches",value:function(e,t){return!(e&&this._kind!=e||t&&this._value!==t)}},{key:"_parseExpression",value:function(){if(!this._token)return this._ast.empty();var e=this._parseUnary();return e?this._parsePrecedence(e,0):null}},{key:"_parsePrecedence",value:function(e,t){for(console.assert(e);this._token;)if(this._matches(I,"(")){var n=this._parseArguments();e=this._ast.invoke(e,null,n)}else if(this._matches(I,"[")){var r=this._parseIndex();e=this._ast.index(e,r)}else if(this._matches(p)){this._advance();var i=this._parseUnary();e=this._makeInvokeOrGetter(e,i)}else{if(this._matches(E))break;if(!(this._matches(m)&&this._token.precedence>=t))break;e="?"==this._value?this._parseTernary(e):this._parseBinary(e)}return e}},{key:"_makeInvokeOrGetter",value:function(e,t){if("ID"===t.type)return this._ast.getter(e,t.value);if("Invoke"===t.type&&"ID"===t.receiver.type){var n=t.receiver;return this._ast.invoke(e,n.value,t.arguments)}throw new Error("expected identifier: "+t)}},{key:"_parseBinary",value:function(e){var t=this._token;if(-1===_.indexOf(t.value))throw new Error("unknown operator: "+t.value);this._advance();for(var n=this._parseUnary();(this._kind==m||this._kind==p||this._kind==I)&&this._token.precedence>t.precedence;)n=this._parsePrecedence(n,this._token.precedence);return this._ast.binary(e,t.value,n)}},{key:"_parseUnary",value:function(){if(this._matches(m)){var e=this._value;if(this._advance(),"+"===e||"-"===e){if(this._matches(x))return this._parseInteger(e);if(this._matches(g))return this._parseDecimal(e)}if(-1===c.indexOf(e))throw new Error("unexpected token: "+e);var t=this._parsePrecedence(this._parsePrimary(),l);return this._ast.unary(e,t)}return this._parsePrimary()}},{key:"_parseTernary",value:function(e){this._advance(m,"?");var t=this._parseExpression();this._advance(y);var n=this._parseExpression();return this._ast.ternary(e,t,n)}},{key:"_parsePrimary",value:function(){switch(this._kind){case E:var e=this._value;if("this"===e)return this._advance(),this._ast.id(e);if(-1!==o.indexOf(e))throw new Error("unexpected keyword: "+e);throw new Error("unrecognized keyword: "+e);case d:return this._parseInvokeOrIdentifier();case f:return this._parseString();case x:return this._parseInteger();case g:return this._parseDecimal();case I:return"("==this._value?this._parseParen():"{"==this._value?this._parseMap():"["==this._value?this._parseList():null;case y:throw new Error('unexpected token ":"');default:return null}}},{key:"_parseList",value:function(){var e=[];do{if(this._advance(),this._matches(I,"]"))break;e.push(this._parseExpression())}while(this._matches(k));return this._advance(I,"]"),this._ast.list(e)}},{key:"_parseMap",value:function(){var e={};do{if(this._advance(),this._matches(I,"}"))break;var t=this._value;this._advance(f),this._advance(y),e[t]=this._parseExpression()}while(this._matches(k));return this._advance(I,"}"),this._ast.map(e)}},{key:"_parseInvokeOrIdentifier",value:function(){var e=this._value;if("true"===e)return this._advance(),this._ast.literal(!0);if("false"===e)return this._advance(),this._ast.literal(!1);if("null"==e)return this._advance(),this._ast.literal(null);var t=this._parseIdentifier(),n=this._parseArguments();return n?this._ast.invoke(t,null,n):t}},{key:"_parseIdentifier",value:function(){if(!this._matches(d))throw new Error("expected identifier: "+this._value);var e=this._value;return this._advance(),this._ast.id(e)}},{key:"_parseArguments",value:function(){if(this._matches(I,"(")){var e=[];do{if(this._advance(),this._matches(I,")"))break;var t=this._parseExpression();e.push(t)}while(this._matches(k));return this._advance(I,")"),e}return null}},{key:"_parseIndex",value:function(){if(this._matches(I,"[")){this._advance();var e=this._parseExpression();return this._advance(I,"]"),e}return null}},{key:"_parseParen",value:function(){this._advance();var e=this._parseExpression();return this._advance(I,")"),this._ast.paren(e)}},{key:"_parseString",value:function(){var e=this._ast.literal(this._value);return this._advance(),e}},{key:"_parseInteger",value:function(e){e=e||"";var t=this._ast.literal(parseInt(""+e+this._value,10));return this._advance(),t}},{key:"_parseDecimal",value:function(e){e=e||"";var t=this._ast.literal(parseFloat(""+e+this._value));return this._advance(),t}}]),e}()}),define(["exports"],function(e){function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r={"+":function(e,t){return e+t},"-":function(e,t){return e-t},"*":function(e,t){return e*t},"/":function(e,t){return e/t},"%":function(e,t){return e%t},"==":function(e,t){return e==t},"!=":function(e,t){return e!=t},"===":function(e,t){return e===t},"!==":function(e,t){return e!==t},">":function(e,t){return e>t},">=":function(e,t){return e>=t},"<":function(e,t){return t>e},"<=":function(e,t){return t>=e},"||":function(e,t){return e||t},"&&":function(e,t){return e&&t},"|":function(e,t){return t(e)}},i={"+":function(e){return e},"-":function(e){return-e},"!":function(e){return!e}};e.EvalAstFactory=function(){function e(){t(this,e)}return n(e,[{key:"empty",value:function(){return{evaluate:function(e){return e},getIds:function(e){return e}}}},{key:"literal",value:function(e){return{type:"Literal",value:e,evaluate:function(e){return this.value},getIds:function(e){return e}}}},{key:"id",value:function(e){return{type:"ID",value:e,evaluate:function(e){return"this"===this.value?e:e[this.value]},getIds:function(e){return e.push(this.value),e}}}},{key:"unary",value:function(e,t){var n=i[e];return{type:"Unary",operator:e,child:t,evaluate:function(e){return n(this.child.evaluate(e))},getIds:function(e){return this.child.getIds(e)}}}},{key:"binary",value:function(e,t,n){var i=r[t];return{type:"Binary",operator:t,left:e,right:n,evaluate:function(e){return i(this.left.evaluate(e),this.right.evaluate(e))},getIds:function(e){return this.left.getIds(e),this.right.getIds(e),e}}}},{key:"getter",value:function(e,t){return{type:"Getter",receiver:e,name:t,evaluate:function(e){return this.receiver.evaluate(e)[this.name]},getIds:function(e){return this.receiver.getIds(e),e}}}},{key:"invoke",value:function(e,t,n){if(null!=t&&"string"!=typeof t)throw new Error("method not a string");return{type:"Invoke",receiver:e,method:t,arguments:n,evaluate:function(e){var n=this.receiver.evaluate(e),r=(this.method?n:e["this"]||e,this.method?n[t]:n),i=this.arguments.map(function(t){return t.evaluate(e)});return r.apply(n,i)},getIds:function(e){return this.receiver.getIds(e),this.arguments.forEach(function(t){return t.getIds(e)}),e}}}},{key:"parenthesized",value:function(e){return e}},{key:"index",value:function(e,t){return{type:"Index",receiver:e,argument:t,evaluate:function(e){return this.receiver.evaluate(e)[this.argument.evaluate(e)]},getIds:function(e){return this.receiver.getIds(e),e}}}},{key:"ternary",value:function(e,t,n){return{type:"Ternary",condition:e,trueExpr:t,falseExpr:n,evaluate:function(e){var t=this.condition.evaluate(e);return t?this.trueExpr.evaluate(e):this.falseExpr.evaluate(e)},getIds:function(e){return this.condition.getIds(e),this.trueExpr.getIds(e),this.falseExpr.getIds(e),e}}}},{key:"map",value:function(e){return{type:"Map",entries:e,evaluate:function(t){var n={};for(var r in e)n[r]=this.entries[r].evaluate(t);return n},getIds:function(t){for(var n in e)this.entries[n].getIds(t);return t}}}},{key:"list",value:function(e){return{type:"List",items:e,evaluate:function(e){return this.items.map(function(t){return t.evaluate(e)})},getIds:function(e){return this.items.forEach(function(t){t.getIds(e)}),e}}}}]),e}()});